@page
@model WARazor.Pages.IndexModel
@{
    ViewData["Title"] = "Registrar tareas";
}

@section Toolbar {
    <a class="btn btn-success" data-bs-toggle="modal" data-bs-target="#mdlNuevaTarea">
        <i class="fa fa-plus"></i> Registrar tarea
    </a>
    <a class="btn btn-outline-light" asp-page="/Index">
        <i class="fa fa-rotate-right"></i> Refrescar
    </a>
}

<div class="container-fluid">

    @* Mensajes *@
    @if (TempData["ok"] is string ok && !string.IsNullOrWhiteSpace(ok))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fa fa-check-circle me-1"></i>@ok
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["err"] is string err && !string.IsNullOrWhiteSpace(err))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fa fa-triangle-exclamation me-1"></i>@err
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="mb-3"></div>

    <!-- Filtros -->
    <form method="get" class="row g-2 align-items-end mb-3 filters">
        <div class="col-12 col-md-4">
            <label class="form-label mb-1">Buscar</label>
            <input type="text" name="q" value="@Model.Buscar"
                   class="form-control" placeholder="Nombre de la tarea..." />
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label mb-1 d-block">Estados visibles</label>
            <div class="d-flex gap-3 flex-wrap">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="stPend"
                           name="estados" value="Pendiente"
                           checked="@(Model.EstadosSeleccionados.Contains("Pendiente"))" />
                    <label class="form-check-label" for="stPend">Pendiente</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="stCurso"
                           name="estados" value="En curso"
                           checked="@(Model.EstadosSeleccionados.Contains("En curso"))" />
                    <label class="form-check-label" for="stCurso">En curso</label>
                </div>
            </div>
        </div>

        <div class="col-6 col-md-2">
            <label class="form-label mb-1">Orden</label>
            <select name="order" class="form-select">
                <option value="az" selected="@("az"==Model.Orden)">A → Z</option>
                <option value="za" selected="@("za"==Model.Orden)">Z → A</option>
                <option value="fasc" selected="@("fasc"==Model.Orden)">Fecha ↑</option>
                <option value="fdesc" selected="@("fdesc"==Model.Orden)">Fecha ↓</option>
            </select>
        </div>

        <div class="col-6 col-md-2">
            <label class="form-label mb-1">Tamaño</label>
            <select name="tam" class="form-select">
                <option value="5" selected="@(Model.TamanoPagina==5)">5</option>
                <option value="10" selected="@(Model.TamanoPagina==10)">10</option>
                <option value="20" selected="@(Model.TamanoPagina==20)">20</option>
            </select>
        </div>

        <div class="col-12">
            <button class="btn btn-outline-secondary">Aplicar</button>
        </div>
    </form>

    <!-- Tabla -->
    <div class="table-responsive shadow-card p-2">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Nombre Tarea</th>
                    <th>Fecha Vencimiento</th>
                    <th>Estado</th>
                    <th style="width:240px">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model.Tareas)
                {
                    <tr>
                        <td>@t.nombreTarea</td>
                        <td>@t.fechaVencimiento.ToString("dd/MM/yyyy")</td>
                        <td>
                            <span class="badge @(t.estado switch {
                            "Pendiente"  => "bg-warning text-dark",
                            "En curso"   => "bg-info",
                            "Finalizado" => "bg-success",
                            "Cancelado"  => "bg-danger",
                            _            => "bg-secondary"
                        })">@t.estado</span>
                        </td>
                        <td class="text-nowrap">
                            @* Finalizar *@
                            @if (!string.Equals(t.estado, "Finalizado", StringComparison.OrdinalIgnoreCase))
                            {
                                <form method="post" asp-page-handler="Estado" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@t.Id" />
                                    <input type="hidden" name="estado" value="Finalizado" />
                                    <input type="hidden" name="pagina" value="@Model.PaginaActual" />
                                    <input type="hidden" name="q" value="@Model.Buscar" />
                                    <input type="hidden" name="order" value="@Model.Orden" />
                                    <input type="hidden" name="tam" value="@Model.TamanoPagina" />
                                    @foreach (var es in Model.EstadosSeleccionados)
                                    {
                                        <input type="hidden" name="estados" value="@es" />
                                    }
                                    <button class="btn btn-sm btn-success" title="Marcar como finalizada">
                                        <i class="fa fa-check"></i>
                                    </button>
                                </form>
                            }

                            @* Cancelar *@
                            @if (!string.Equals(t.estado, "Cancelado", StringComparison.OrdinalIgnoreCase))
                            {
                                <form method="post" asp-page-handler="Estado" class="d-inline ms-1">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@t.Id" />
                                    <input type="hidden" name="estado" value="Cancelado" />
                                    <input type="hidden" name="pagina" value="@Model.PaginaActual" />
                                    <input type="hidden" name="q" value="@Model.Buscar" />
                                    <input type="hidden" name="order" value="@Model.Orden" />
                                    <input type="hidden" name="tam" value="@Model.TamanoPagina" />
                                    @foreach (var es in Model.EstadosSeleccionados)
                                    {
                                        <input type="hidden" name="estados" value="@es" />
                                    }
                                    <button class="btn btn-sm btn-danger" title="Cancelar">
                                        <i class="fa fa-xmark"></i>
                                    </button>
                                </form>
                            }

                            @* Editar (muestra formulario abajo) *@
                            <a class="btn btn-sm btn-primary ms-1"
                               asp-page="/Index"
                               asp-route-editId="@t.Id"
                               asp-route-pagina="@Model.PaginaActual"
                               asp-route-q="@Model.Buscar"
                               asp-route-order="@Model.Orden"
                               asp-route-tam="@Model.TamanoPagina"
                               title="Editar">
                                <i class="fa fa-pen"></i>
                            </a>

                            @* Eliminar (ARREGLADO) *@
                            <form method="post" asp-page-handler="Eliminar" class="d-inline ms-1"
                                  onsubmit="return confirm('¿Eliminar la tarea &quot;@t.nombreTarea&quot;?');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@t.Id" />
                                <input type="hidden" name="pagina" value="@Model.PaginaActual" />
                                <input type="hidden" name="q" value="@Model.Buscar" />
                                <input type="hidden" name="order" value="@Model.Orden" />
                                <input type="hidden" name="tam" value="@Model.TamanoPagina" />
                                @foreach (var es in Model.EstadosSeleccionados)
                                {
                                    <input type="hidden" name="estados" value="@es" />
                                }
                                <button class="btn btn-sm btn-outline-danger" title="Eliminar">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    <nav aria-label="Paginación" class="mt-3">
        <ul class="pagination justify-content-center">
            <li class="page-item @(Model.PaginaActual==1 ? "disabled" : "")">
                <a class="page-link"
                   href="@Url.Page("/Index", new {
                        pagina = Model.PaginaActual - 1,
                        q = Model.Buscar,
                        order = Model.Orden,
                        tam = Model.TamanoPagina,
                        estados = Model.EstadosSeleccionados
                    })">Anterior</a>
            </li>

            @for (int i = 1; i <= Model.TotalPaginas; i++)
            {
                <li class="page-item @(i==Model.PaginaActual ? "active" : "")">
                    <a class="page-link"
                       href='@Url.Page("/Index", new {
                            pagina = i,
                            q = Model.Buscar,
                            order = Model.Orden,
                            tam = Model.TamanoPagina,
                            estados = Model.EstadosSeleccionados
                        })'>@i</a>
                </li>
            }

            <li class="page-item @(Model.PaginaActual==Model.TotalPaginas ? "disabled" : "")">
                <a class="page-link"
                   href="@Url.Page("/Index", new {
                        pagina = Model.PaginaActual + 1,
                        q = Model.Buscar,
                        order = Model.Orden,
                        tam = Model.TamanoPagina,
                        estados = Model.EstadosSeleccionados
                    })">Siguiente</a>
            </li>
        </ul>
    </nav>

    @* Formulario de edición inline *@
    @if (Model.EditId.HasValue)
    {
        <div class="shadow-card p-3 mt-3">
            <h5 class="mb-3">Editar tarea</h5>
            <form method="post" asp-page-handler="Editar" class="row g-2">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="Editar.Id" />
                <div class="col-12 col-md-5">
                    <label class="form-label">Nombre</label>
                    <input class="form-control" asp-for="Editar.nombreTarea" required />
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label">Vence</label>
                    <input type="date" class="form-control" asp-for="Editar.fechaVencimiento" required />
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Estado</label>
                    <select class="form-select" asp-for="Editar.estado">
                        <option>Pendiente</option>
                        <option>En curso</option>
                        <option>Finalizado</option>
                        <option>Cancelado</option>
                    </select>
                </div>
                <div class="col-12 col-md-2 d-flex align-items-end gap-2">
                    <button class="btn btn-primary">Guardar</button>
                    <a class="btn btn-outline-secondary" asp-page="/Index"
                       asp-route-pagina="@Model.PaginaActual"
                       asp-route-q="@Model.Buscar"
                       asp-route-order="@Model.Orden"
                       asp-route-tam="@Model.TamanoPagina">Cancelar</a>
                </div>
            </form>
        </div>
    }
</div>

<!-- Modal Registrar -->
<div class="modal fade" id="mdlNuevaTarea" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" method="post" asp-page-handler="Create">
            @Html.AntiForgeryToken()
            <div class="modal-header">
                <h5 class="modal-title">Registrar tarea</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">Nombre</label>
                    <input class="form-control" name="Nueva.nombreTarea" required />
                </div>
                <div class="mb-2">
                    <label class="form-label">Fecha vencimiento</label>
                    <input type="date" class="form-control" name="Nueva.fechaVencimiento" required />
                </div>
                <div class="mb-2">
                    <label class="form-label">Estado</label>
                    <select class="form-select" name="Nueva.estado" required>
                        <option>Pendiente</option>
                        <option>En curso</option>
                        <option>Finalizado</option>
                        <option>Cancelado</option>
                    </select>
                </div>
                <small class="text-muted">Se guardará en <code>wwwroot/tareas.json</code>.</small>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cerrar</button>
                <button class="btn btn-primary" type="submit">Guardar</button>
            </div>
        </form>
    </div>
</div>
